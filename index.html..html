<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Nexus">
<meta name="application-name" content="Nexus">
<meta name="theme-color" content="#0a1628">
<title>Nexus</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="Nexus_Logo.jpg">
<link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #000;
    --bg2: #1c1c1e;
    --bg3: #2c2c2e;
    --bg4: #3a3a3c;
    --text: #fff;
    --text2: #ebebf5cc;
    --text3: #ebebf599;
    --accent: #2d8ef7;
    --accent2: #1a5fc8;
    --green: #30d158;
    --red: #ff453a;
    --yellow: #ffd60a;
    --blue: #0a84ff;
    --safe-top: env(safe-area-inset-top, 44px);
    --safe-bottom: env(safe-area-inset-bottom, 34px);
  }
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
  html, body { height:100%; overflow:hidden; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    overscroll-behavior: none;
  }

  /* APP SHELL */
  .app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: 100dvh;
  }

  /* STATUS BAR SPACER */
  .status-bar {
    height: var(--safe-top);
    background: var(--bg);
    flex-shrink: 0;
  }

  /* NAV TABS */
  .tab-bar {
    display: flex;
    background: rgba(28,28,30,0.92);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid rgba(255,255,255,0.1);
    padding-bottom: var(--safe-bottom);
    flex-shrink: 0;
    order: 3;
  }
  .tab {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 8px 0 4px;
    cursor: pointer;
    gap: 3px;
    transition: opacity 0.15s;
  }
  .tab:active { opacity: 0.6; }
  .tab-icon { font-size: 1.5rem; line-height: 1; }
  .tab-label { font-size: 0.62rem; font-weight: 500; color: var(--text3); letter-spacing: 0.01em; }
  .tab.active .tab-label { color: var(--accent); }
  .tab.active .tab-icon { filter: none; }

  /* SCREENS */
  .screens { flex: 1; overflow: hidden; order: 2; position: relative; }
  .screen { position: absolute; inset: 0; overflow-y: auto; overflow-x: hidden; -webkit-overflow-scrolling: touch; display: none; padding-bottom: 16px; }
  .screen.active { display: block; }

  /* HEADER */
  .screen-header {
    padding: 16px 20px 8px;
    position: sticky;
    top: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    z-index: 10;
    border-bottom: 1px solid rgba(255,255,255,0.06);
  }
  .screen-title { font-size: 1.7rem; font-weight: 800; letter-spacing: -0.03em; }
  .screen-title span { color: var(--accent); }
  .screen-subtitle { font-size: 0.75rem; color: var(--text3); margin-top: 2px; }

  /* CARDS */
  .card {
    background: var(--bg2);
    border-radius: 16px;
    margin: 12px 16px 0;
    overflow: hidden;
  }
  .card-header {
    padding: 14px 16px 10px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text3);
  }

  /* TOTAL VALUE HERO */
  .hero-card {
    background: linear-gradient(135deg, #0a1628 0%, #0d2245 100%);
    border-radius: 20px;
    margin: 12px 16px 0;
    padding: 24px 20px;
    position: relative;
    overflow: hidden;
  }
  .hero-card::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 160px; height: 160px;
    background: radial-gradient(circle, rgba(45,142,247,0.25) 0%, transparent 70%);
  }
  .hero-label { font-size: 0.72rem; color: rgba(255,255,255,0.5); font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.06em; }
  .hero-value { font-size: 2.6rem; font-weight: 800; letter-spacing: -0.04em; line-height: 1; }
  .hero-sub { display: flex; gap: 16px; margin-top: 16px; }
  .hero-stat { }
  .hero-stat-val { font-size: 0.9rem; font-weight: 700; }
  .hero-stat-label { font-size: 0.62rem; color: rgba(255,255,255,0.4); margin-top: 1px; }

  /* PIE CHART */
  .pie-wrap {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 16px;
  }
  .pie-svg-wrap { position: relative; width: 130px; height: 130px; flex-shrink: 0; }
  svg.pie { width: 100%; height: 100%; }
  .pie-center-label {
    position: absolute; top: 50%; left: 50%;
    transform: translate(-50%,-50%);
    text-align: center; pointer-events: none;
  }
  .pie-center-label .pv { font-size: 0.75rem; font-weight: 700; }
  .pie-center-label .pl { font-size: 0.52rem; color: var(--text3); }
  .legend-list { flex: 1; display: flex; flex-direction: column; gap: 7px; }
  .legend-row { display: flex; align-items: center; gap: 8px; }
  .legend-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
  .legend-name { flex: 1; font-size: 0.78rem; font-weight: 600; }
  .legend-pct { font-size: 0.72rem; color: var(--text3); font-variant-numeric: tabular-nums; }

  /* HOLDINGS LIST */
  .holding-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    cursor: pointer;
    transition: background 0.15s;
    position: relative;
  }
  .holding-row:last-child { border-bottom: none; }
  .holding-row:active { background: rgba(255,255,255,0.05); }
  .company-logo {
    width: 42px; height: 42px;
    border-radius: 12px;
    background: var(--bg3);
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
    flex-shrink: 0;
    font-size: 1.1rem;
    font-weight: 800;
    color: #fff;
    position: relative;
  }
  .company-logo img { width: 100%; height: 100%; object-fit: contain; padding: 6px; border-radius: 12px; }
  .holding-info { flex: 1; min-width: 0; }
  .holding-ticker { font-size: 0.88rem; font-weight: 700; }
  .holding-name { font-size: 0.7rem; color: var(--text3); margin-top: 1px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .holding-right { text-align: right; flex-shrink: 0; }
  .holding-value { font-size: 0.88rem; font-weight: 700; font-variant-numeric: tabular-nums; }
  .holding-pct { font-size: 0.7rem; color: var(--text3); margin-top: 1px; font-variant-numeric: tabular-nums; }
  .color-dot-btn {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
    cursor: pointer;
    border: 1.5px solid rgba(255,255,255,0.2);
  }

  /* SECTOR GRID */
  .sector-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: rgba(255,255,255,0.06); }
  .sector-cell {
    background: var(--bg2);
    padding: 14px;
  }
  .sector-name { font-size: 0.62rem; color: var(--text3); text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 5px; }
  .sector-val { font-size: 0.95rem; font-weight: 700; margin-bottom: 5px; }
  .sector-bar-bg { height: 3px; background: var(--bg3); border-radius: 99px; overflow: hidden; margin-bottom: 4px; }
  .sector-bar { height: 100%; border-radius: 99px; }
  .sector-pct { font-size: 0.65rem; color: var(--text3); }
  .sector-tickers { font-size: 0.6rem; color: var(--text3); margin-top: 2px; opacity: 0.7; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

  /* ADD FORM */
  .form-section { padding: 0 16px; margin-top: 12px; }
  .input-group { background: var(--bg2); border-radius: 14px; overflow: hidden; margin-bottom: 12px; }
  .input-row {
    display: flex;
    align-items: center;
    padding: 0 16px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    min-height: 50px;
  }
  .input-row:last-child { border-bottom: none; }
  .input-label { font-size: 0.85rem; font-weight: 500; min-width: 110px; color: var(--text2); }
  .input-field {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text);
    font-family: inherit;
    font-size: 0.85rem;
    text-align: right;
    outline: none;
    padding: 14px 0;
  }
  .input-field::placeholder { color: var(--text3); }
  .input-field option { background: var(--bg2); }
  select.input-field { cursor: pointer; }

  .add-btn {
    width: 100%;
    background: var(--accent);
    color: #fff;
    font-family: inherit;
    font-size: 1rem;
    font-weight: 700;
    padding: 16px;
    border: none;
    border-radius: 14px;
    cursor: pointer;
    letter-spacing: 0.01em;
    transition: opacity 0.15s, transform 0.1s;
    margin-bottom: 12px;
  }
  .add-btn:active { opacity: 0.8; transform: scale(0.98); }
  .error-msg { color: var(--red); font-size: 0.78rem; text-align: center; margin-bottom: 10px; font-weight: 500; }

  /* COLOR PICKER SHEET */
  .sheet-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    display: none;
    backdrop-filter: blur(4px);
  }
  .sheet-overlay.open { display: flex; align-items: flex-end; }
  .sheet {
    background: var(--bg2);
    border-radius: 20px 20px 0 0;
    padding: 20px 20px calc(20px + var(--safe-bottom));
    width: 100%;
    animation: slideUp 0.3s ease;
  }
  .sheet-handle { width: 36px; height: 4px; background: var(--bg4); border-radius: 99px; margin: 0 auto 18px; }
  .sheet-title { font-size: 1rem; font-weight: 700; margin-bottom: 16px; text-align: center; }
  .color-grid { display: grid; grid-template-columns: repeat(6,1fr); gap: 10px; margin-bottom: 16px; }
  .color-dot {
    width: 100%; aspect-ratio: 1;
    border-radius: 50%;
    cursor: pointer;
    border: 2.5px solid transparent;
    transition: transform 0.15s;
  }
  .color-dot:active { transform: scale(0.9); }
  .color-dot.selected { border-color: #fff; }
  .custom-row { display: flex; align-items: center; gap: 12px; padding: 12px 0; }
  .custom-label { font-size: 0.85rem; color: var(--text2); flex: 1; }
  input[type="color"] { width: 44px; height: 36px; border-radius: 8px; border: 1px solid var(--bg4); background: var(--bg3); padding: 3px; cursor: pointer; }
  .sheet-cancel { width: 100%; background: var(--bg3); color: var(--text); font-family: inherit; font-size: 1rem; font-weight: 600; padding: 15px; border: none; border-radius: 14px; cursor: pointer; margin-top: 8px; }

  /* DELETE SWIPE */
  .delete-btn {
    background: var(--red);
    color: white;
    border: none;
    font-family: inherit;
    font-size: 0.72rem;
    font-weight: 600;
    padding: 6px 12px;
    border-radius: 8px;
    cursor: pointer;
    flex-shrink: 0;
  }

  /* EMPTY STATE */
  .empty { text-align: center; padding: 48px 24px; color: var(--text3); }
  .empty-icon { font-size: 3rem; margin-bottom: 12px; }
  .empty-title { font-size: 1rem; font-weight: 600; color: var(--text2); margin-bottom: 6px; }
  .empty-sub { font-size: 0.8rem; line-height: 1.5; }

  @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
  .screen.active { animation: fadeIn 0.25s ease; }

  /* SCROLLBAR */
  ::-webkit-scrollbar { display: none; }
</style>
</head>
<body>
<div class="app">
  <div class="status-bar"></div>

  <div class="screens">
    <!-- PORTFOLIO SCREEN -->
    <div class="screen active" id="screen-portfolio">
      <div class="screen-header">
        <div class="screen-title">Nexus <span>Portfolio</span></div>
        <div class="screen-subtitle" id="headerSub">Loading...</div>
      </div>

      <!-- HERO -->
      <div class="hero-card">
        <div class="hero-label">Total Value</div>
        <div class="hero-value" id="heroTotal">$0.00</div>
        <div class="hero-sub">
          <div class="hero-stat">
            <div class="hero-stat-val" id="heroHoldings">0</div>
            <div class="hero-stat-label">Holdings</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-val" id="heroLargest">‚Äî</div>
            <div class="hero-stat-label">Largest</div>
          </div>
          <div class="hero-stat">
            <div class="hero-stat-val" id="heroDiversif" style="font-size:0.78rem">‚Äî</div>
            <div class="hero-stat-label">Diversif.</div>
          </div>
        </div>
      </div>

      <!-- PIE -->
      <div class="card">
        <div class="card-header">Allocation</div>
        <div class="pie-wrap" id="pieWrap">
          <div style="text-align:center;padding:20px;color:var(--text3);font-size:0.8rem;width:100%">Add positions to see allocation</div>
        </div>
      </div>

      <!-- HOLDINGS -->
      <div class="card" style="margin-bottom:0">
        <div class="card-header">Holdings</div>
        <div id="holdingsList">
          <div class="empty">
            <div class="empty-icon">üìà</div>
            <div class="empty-title">No positions yet</div>
            <div class="empty-sub">Tap the Add tab below to add your first stock</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SECTORS SCREEN -->
    <div class="screen" id="screen-sectors">
      <div class="screen-header">
        <div class="screen-title">Sectors</div>
        <div class="screen-subtitle">Diversification breakdown</div>
      </div>
      <div class="card" style="margin-bottom:0;padding-bottom:0">
        <div id="sectorContent">
          <div class="empty">
            <div class="empty-icon">üè≠</div>
            <div class="empty-title">No sectors yet</div>
            <div class="empty-sub">Add positions to see sector breakdown</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADD SCREEN -->
    <div class="screen" id="screen-add">
      <div class="screen-header">
        <div class="screen-title">Add Position</div>
        <div class="screen-subtitle">Add or update a holding</div>
      </div>
      <div class="form-section">
        <div class="input-group">
          <div class="input-row">
            <span class="input-label">Ticker</span>
            <input class="input-field" id="fTicker" placeholder="AAPL" maxlength="8" autocapitalize="characters" autocorrect="off">
          </div>
          <div class="input-row">
            <span class="input-label">Company</span>
            <input class="input-field" id="fName" placeholder="Apple Inc." autocorrect="off">
          </div>
          <div class="input-row">
            <span class="input-label">Shares</span>
            <input class="input-field" id="fShares" placeholder="10" type="number" inputmode="decimal" min="0" step="any">
          </div>
          <div class="input-row">
            <span class="input-label">Avg Price ($)</span>
            <input class="input-field" id="fPrice" placeholder="150.00" type="number" inputmode="decimal" min="0" step="any">
          </div>
          <div class="input-row">
            <span class="input-label">Sector</span>
            <select class="input-field" id="fSector">
              <option value="Tech">Technology</option>
              <option value="Finance">Finance</option>
              <option value="Health">Healthcare</option>
              <option value="Energy">Energy</option>
              <option value="Consumer">Consumer</option>
              <option value="Industrial">Industrial</option>
              <option value="ETF">ETF / Index</option>
              <option value="Crypto">Crypto</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>
        <div class="error-msg" id="formError" style="display:none"></div>
        <button class="add-btn" onclick="addPosition()">Add Position</button>
      </div>
    </div>
  </div>

  <!-- TAB BAR -->
  <div class="tab-bar">
    <div class="tab active" onclick="switchTab('portfolio', this)">
      <div class="tab-icon">üìä</div>
      <div class="tab-label">Portfolio</div>
    </div>
    <div class="tab" onclick="switchTab('sectors', this)">
      <div class="tab-icon">üè≠</div>
      <div class="tab-label">Sectors</div>
    </div>
    <div class="tab" onclick="switchTab('add', this)">
      <div class="tab-icon">Ôºã</div>
      <div class="tab-label">Add</div>
    </div>
  </div>
</div>

<!-- COLOR PICKER SHEET -->
<div class="sheet-overlay" id="colorSheet" onclick="closeColorSheet(event)">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">Change Color</div>
    <div class="color-grid" id="colorGrid"></div>
    <div class="custom-row">
      <span class="custom-label">Custom color</span>
      <input type="color" id="customColor" oninput="applyColor(this.value)">
    </div>
    <button class="sheet-cancel" onclick="closeColorSheetDirect()">Done</button>
  </div>
</div>

<script>
const COLORS = ['#7c6af7','#f7c26a','#6af7c2','#f76a6a','#6ac4f7','#f76adb','#a8f76a','#f7a86a','#ff6b6b','#30d158'];
const PRESET_COLORS = [
  '#7c6af7','#f7c26a','#6af7c2','#f76a6a','#6ac4f7','#f76adb',
  '#a8f76a','#f7a86a','#ff6b6b','#30d158','#ffd60a','#0a84ff',
  '#ff9f0a','#bf5af2','#32ade6','#ff375f','#6ac4dc','#99fb98',
  '#ff453a','#5e5ce6','#64d2ff','#ff9f0a','#ac8e68','#ebebf5'
];
const SECTOR_COLORS = {
  'Tech':'#7c6af7','Finance':'#f7c26a','Health':'#6af7c2','Energy':'#f76a6a',
  'Consumer':'#6ac4f7','Industrial':'#f76adb','ETF':'#a8f76a','Crypto':'#f7a86a','Other':'#6b6b8a'
};

// Company logo - tries multiple sources in order, covers virtually every broker ticker
function getLogoUrls(ticker) {
  const t = ticker.toUpperCase();
  return [
    `https://assets.parqet.com/logos/symbol/${t}?format=png`,
    `https://img.logo.dev/ticker/${t}?token=pk_J5gBRRFzQ0OINFJlILmDuA`,
    `https://financialmodelingprep.com/image-stock/${t}.png`,
  ];
}

function getTickerColor(ticker) {
  const colors = ['#7c6af7','#f7c26a','#6af7c2','#f76a6a','#6ac4f7','#f76adb','#a8f76a','#30d158','#0a84ff','#ff9f0a'];
  let hash = 0;
  for (let c of ticker) hash = c.charCodeAt(0) + ((hash << 5) - hash);
  return colors[Math.abs(hash) % colors.length];
}

function createLogoEl(ticker, size=42) {
  const urls = getLogoUrls(ticker);
  let idx = 0;
  const wrap = document.createElement('div');
  wrap.style.cssText = `width:${size}px;height:${size}px;border-radius:12px;background:#2c2c2e;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;`;
  const img = document.createElement('img');
  img.alt = ticker;
  img.style.cssText = 'width:100%;height:100%;object-fit:contain;padding:5px;';
  img.onerror = () => {
    idx++;
    if (idx < urls.length) { img.src = urls[idx]; }
    else {
      wrap.style.background = getTickerColor(ticker);
      wrap.innerHTML = `<span style="font-size:${size*0.4}px;font-weight:800;color:#fff">${ticker.charAt(0)}</span>`;
    }
  };
  img.src = urls[0];
  wrap.appendChild(img);
  return wrap;
}

let holdings = JSON.parse(localStorage.getItem('ms_portfolio_v3') || '[]');
let colorPickerTicker = null;

function save() { localStorage.setItem('ms_portfolio_v3', JSON.stringify(holdings)); }
const fmt = n => '$' + Number(n).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2});

function switchTab(name, el) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
  el.classList.add('active');
}

function addPosition() {
  const ticker = document.getElementById('fTicker').value.trim().toUpperCase();
  const name = document.getElementById('fName').value.trim();
  const shares = parseFloat(document.getElementById('fShares').value);
  const price = parseFloat(document.getElementById('fPrice').value);
  const sector = document.getElementById('fSector').value;
  const errEl = document.getElementById('formError');

  if (!ticker || !shares || !price) {
    errEl.textContent = 'Please fill in Ticker, Shares and Price.';
    errEl.style.display = 'block';
    return;
  }
  errEl.style.display = 'none';

  const idx = holdings.findIndex(h => h.ticker === ticker);
  if (idx >= 0) {
    const old = holdings[idx];
    const ns = old.shares + shares;
    holdings[idx] = {...old, shares: ns, price: ((old.shares*old.price)+(shares*price))/ns, name: name||old.name};
  } else {
    holdings.push({ticker, name: name||ticker, shares, price, sector, color: COLORS[holdings.length % COLORS.length]});
  }
  save();
  render();
  ['fTicker','fName','fShares','fPrice'].forEach(id => document.getElementById(id).value = '');
  // Switch to portfolio tab
  document.querySelectorAll('.tab')[0].click();
}

function removeHolding(ticker) {
  if (!confirm(`Remove ${ticker}?`)) return;
  holdings = holdings.filter(h => h.ticker !== ticker);
  save(); render();
}

function openColorSheet(ticker) {
  colorPickerTicker = ticker;
  const h = holdings.find(x => x.ticker === ticker);
  document.getElementById('sheetTitle').textContent = ticker + ' ‚Äî Pick Color';
  document.getElementById('customColor').value = h.color;
  const grid = document.getElementById('colorGrid');
  grid.innerHTML = PRESET_COLORS.map(c => `
    <div class="color-dot ${c===h.color?'selected':''}" style="background:${c}" data-color="${c}" onclick="applyColor('${c}')"></div>
  `).join('');
  document.getElementById('colorSheet').classList.add('open');
}

function applyColor(color) {
  const idx = holdings.findIndex(h => h.ticker === colorPickerTicker);
  if (idx >= 0) { holdings[idx].color = color; save(); render(); }
  document.querySelectorAll('.color-dot').forEach(d => d.classList.toggle('selected', d.dataset.color === color));
  document.getElementById('customColor').value = color;
}

function closeColorSheet(e) {
  if (e.target === document.getElementById('colorSheet')) closeColorSheetDirect();
}
function closeColorSheetDirect() {
  document.getElementById('colorSheet').classList.remove('open');
  colorPickerTicker = null;
}

function render() {
  const total = holdings.reduce((s,h) => s+h.shares*h.price, 0);
  const sorted = [...holdings].sort((a,b) => (b.shares*b.price)-(a.shares*a.price));

  // HERO
  document.getElementById('heroTotal').textContent = fmt(total);
  document.getElementById('heroHoldings').textContent = holdings.length;
  const largest = holdings.length ? holdings.reduce((a,b) => a.shares*a.price>b.shares*b.price?a:b) : null;
  document.getElementById('heroLargest').textContent = largest?.ticker || '‚Äî';
  const maxPct = holdings.length ? holdings.reduce((mx,h) => Math.max(mx,(h.shares*h.price)/total), 0) : 0;
  const divEl = document.getElementById('heroDiversif');
  divEl.textContent = maxPct>0.5?'‚ö† Heavy':maxPct>0.3?'Moderate':'‚úì Spread';
  divEl.style.color = maxPct>0.5?'var(--red)':maxPct<0.3?'var(--green)':'var(--text)';
  document.getElementById('headerSub').textContent = holdings.length ? `${holdings.length} position${holdings.length>1?'s':''} ¬∑ ${fmt(total)}` : 'No positions yet';

  // PIE
  const pieWrap = document.getElementById('pieWrap');
  if (holdings.length === 0) {
    pieWrap.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text3);font-size:0.8rem;width:100%">Add positions to see allocation</div>';
  } else {
    let cum = 0;
    const paths = holdings.map(h => {
      const val = h.shares*h.price, pct = val/total;
      const start = cum*Math.PI*2, end = (cum+pct)*Math.PI*2;
      cum += pct;
      const r=42,cx=50,cy=50;
      const x1=cx+r*Math.cos(start-Math.PI/2), y1=cy+r*Math.sin(start-Math.PI/2);
      const x2=cx+r*Math.cos(end-Math.PI/2), y2=cy+r*Math.sin(end-Math.PI/2);
      if (pct>=0.9999) return `<circle cx="${cx}" cy="${cy}" r="${r}" fill="${h.color}"/>`;
      return `<path d="M ${cx} ${cy} L ${x1} ${y1} A ${r} ${r} 0 ${pct>0.5?1:0} 1 ${x2} ${y2} Z" fill="${h.color}" stroke="#000" stroke-width="1"/>`;
    }).join('');
    const legend = holdings.map(h => {
      const pct = total>0?(h.shares*h.price/total*100).toFixed(1):0;
      return `<div class="legend-row"><div class="legend-dot" style="background:${h.color}"></div><span class="legend-name">${h.ticker}</span><span class="legend-pct">${pct}%</span></div>`;
    }).join('');
    pieWrap.innerHTML = `
      <div class="pie-svg-wrap">
        <svg class="pie" viewBox="0 0 100 100">${paths}<circle cx="50" cy="50" r="28" fill="#1c1c1e"/></svg>
        <div class="pie-center-label"><div class="pv">${holdings.length}</div><div class="pl">stocks</div></div>
      </div>
      <div class="legend-list">${legend}</div>`;
  }

  // HOLDINGS LIST
  const list = document.getElementById('holdingsList');
  if (holdings.length === 0) {
    list.innerHTML = `<div class="empty"><div class="empty-icon">üìà</div><div class="empty-title">No positions yet</div><div class="empty-sub">Tap the Add tab below to get started</div></div>`;
  } else {
    list.innerHTML = sorted.map(h => {
      const val = h.shares*h.price, pct = total>0?(val/total*100).toFixed(1):0;
      const logoUrl = getLogoUrls(h.ticker)[0];
      const logoHtml = `<img src="${logoUrl}" alt="${h.ticker}" style="width:100%;height:100%;object-fit:contain;padding:5px;" onerror="
        var urls=${JSON.stringify(getLogoUrls(h.ticker))};
        var i=(this.dataset.idx=((this.dataset.idx||0)*1+1));
        if(i<urls.length){this.src=urls[i];}
        else{this.parentNode.style.background='${getTickerColor(h.ticker)}';this.parentNode.innerHTML='<span style=font-size:1rem;font-weight:800;color:#fff>${h.ticker.charAt(0)}</span>';}
      ">`;
      const logoBg = '';
      return `<div class="holding-row">
        <div class="company-logo" style="${logoBg}">${logoHtml}</div>
        <div class="holding-info">
          <div class="holding-ticker">${h.ticker}</div>
          <div class="holding-name">${h.name}</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px">
          <div class="holding-right">
            <div class="holding-value">${fmt(val)}</div>
            <div class="holding-pct">${pct}% ¬∑ ${h.shares} shares</div>
          </div>
          <div class="color-dot-btn" style="background:${h.color}" onclick="openColorSheet('${h.ticker}')"></div>
          <button class="delete-btn" onclick="removeHolding('${h.ticker}')">‚úï</button>
        </div>
      </div>`;
    }).join('');
  }

  // SECTORS
  const sectors = {};
  holdings.forEach(h => {
    if (!sectors[h.sector]) sectors[h.sector] = {value:0, tickers:[]};
    sectors[h.sector].value += h.shares*h.price;
    sectors[h.sector].tickers.push(h.ticker);
  });
  const sectorEntries = Object.entries(sectors).sort((a,b)=>b[1].value-a[1].value);
  const maxSV = sectorEntries[0]?.[1].value || 1;
  const sectorContent = document.getElementById('sectorContent');
  if (sectorEntries.length === 0) {
    sectorContent.innerHTML = `<div class="empty"><div class="empty-icon">üè≠</div><div class="empty-title">No sectors yet</div><div class="empty-sub">Add positions to see sector breakdown</div></div>`;
  } else {
    sectorContent.innerHTML = `<div class="sector-grid">${sectorEntries.map(([name,data]) => {
      const pct = total>0?(data.value/total*100).toFixed(1):0;
      const color = SECTOR_COLORS[name]||'#6b6b8a';
      return `<div class="sector-cell">
        <div class="sector-name">${name}</div>
        <div class="sector-val" style="color:${color}">${fmt(data.value)}</div>
        <div class="sector-bar-bg"><div class="sector-bar" style="width:${(data.value/maxSV*100).toFixed(1)}%;background:${color}"></div></div>
        <div class="sector-pct">${pct}% of portfolio</div>
        <div class="sector-tickers">${data.tickers.join(' ¬∑ ')}</div>
      </div>`;
    }).join('')}</div>`;
  }
}

render();
</script>
</body>
</html>
